# ğŸ“‹ ××¨×›×™×˜×§×˜×•×¨×ª ××¢×¨×›×ª ×œ×•×’×™× (Audit Log System)

> **×’×¨×¡×”:** 1.0  
> **×ª××¨×™×š:** December 2024  
> **×¡×˜×˜×•×¡:** ×××•×©×¨ ×œ×¤×™×ª×•×—

---

## ğŸ“Œ ×¡×™×›×•× ×”×—×œ×˜×•×ª

| ×¤×¨××˜×¨ | ×”×—×œ×˜×” |
|-------|-------|
| ×¨××ª ×¤×™×¨×•×˜ | **××œ×** - ×¢×¨×›×™× ×™×©× ×™×/×—×“×©×™× ×œ×›×œ ×©×“×” |
| ××” ×œ×¨×©×•× | **×”×›×œ** - CRUD, Auth, Export, Page Views |
| ××—×¡×•×Ÿ | **DB × ×¤×¨×“ ×œ×›×œ ××¨×’×•×Ÿ** |
| ×ª×§×•×¤×ª ×©××™×¨×” | **××•×ª×× ××™×©×™×ª** (×‘×¨×™×¨×ª ××—×“×œ: 3 ×©× ×™×) |
| ×”×ª×¨××•×ª | **×›×Ÿ** - ××•×ª×× ××™×©×™×ª ×œ××©×ª××© |
| ×™×™×¦×•× | **CSV + Webhook** |

---

## ğŸ—ï¸ ××¨×›×™×˜×§×˜×•×¨×” ×›×œ×œ×™×ª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Application Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚  Rocks   â”‚  â”‚ Sprints  â”‚  â”‚ Stories  â”‚  â”‚   Auth   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â”‚
â”‚       â”‚             â”‚             â”‚             â”‚                â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                           â”‚                                      â”‚
â”‚                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                               â”‚
â”‚                    â”‚ Audit       â”‚                               â”‚
â”‚                    â”‚ Middleware  â”‚                               â”‚
â”‚                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Audit Service Layer                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Log Processor  â”‚  â”‚ Alert Engine    â”‚  â”‚ Export Service  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚                    â”‚                    â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Storage Layer (Per Organization)            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Org A Audit DB â”‚  â”‚  Org B Audit DB â”‚  â”‚  Org C Audit DB â”‚  â”‚
â”‚  â”‚  (PostgreSQL)   â”‚  â”‚  (PostgreSQL)   â”‚  â”‚  (PostgreSQL)   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š ××‘× ×” ×”×˜×‘×œ××•×ª

### 1. AuditLog (×‘×›×œ DB ××¨×’×•× ×™)

```prisma
model AuditLog {
  id             String   @id @default(uuid())
  
  // ===== ××™ =====
  userId         String?      // null = system action
  userEmail      String?
  userName       String?
  userRole       String?      // Role at time of action
  
  // ===== ××” =====
  action         AuditAction  // Enum
  category       AuditCategory
  entityType     String       // Rock, Sprint, Story, etc.
  entityId       String?
  entityName     String?      // For quick reference
  
  // ===== ×©×™× ×•×™×™× =====
  oldValues      Json?        // Full snapshot before
  newValues      Json?        // Full snapshot after
  changedFields  String[]     // ['name', 'progress']
  changesSummary String?      // Human-readable summary
  
  // ===== ××™×“×¢ × ×•×¡×£ =====
  ipAddress      String?
  userAgent      String?
  sessionId      String?
  requestId      String?      // For tracing
  duration       Int?         // Action duration in ms
  metadata       Json?        // Additional context
  
  // ===== ×–××Ÿ =====
  createdAt      DateTime @default(now())
  
  @@index([createdAt])
  @@index([userId])
  @@index([action])
  @@index([entityType, entityId])
  @@index([category])
}

enum AuditAction {
  // CRUD
  CREATE
  READ
  UPDATE
  DELETE
  RESTORE
  
  // Auth
  LOGIN
  LOGOUT
  LOGIN_FAILED
  PASSWORD_CHANGED
  SESSION_EXPIRED
  
  // Admin
  ROLE_CHANGED
  USER_INVITED
  USER_REMOVED
  PERMISSIONS_CHANGED
  
  // Data
  EXPORT_CSV
  EXPORT_PDF
  IMPORT
  BULK_UPDATE
  
  // System
  SETTINGS_CHANGED
  WEBHOOK_TRIGGERED
  ALERT_SENT
}

enum AuditCategory {
  AUTHENTICATION
  DATA_CRUD
  ADMINISTRATION
  EXPORT_IMPORT
  SYSTEM
  PAGE_VIEW
}
```

### 2. AuditAlertConfig (×‘-Main DB)

```prisma
model AuditAlertConfig {
  id             String   @id @default(uuid())
  organizationId String
  organization   Organization @relation(...)
  
  // ××” ××¤×¢×™×œ ×”×ª×¨××”
  triggerActions AuditAction[]  // Which actions trigger alert
  triggerEntities String[]      // Which entity types
  
  // ×œ××™ ×œ×©×œ×•×—
  notifyRoles    String[]       // ['ADMIN', 'MANAGER']
  notifyUserIds  String[]       // Specific users
  
  // ××™×š ×œ×©×œ×•×—
  channels       AlertChannel[] // EMAIL, WEBHOOK, IN_APP
  webhookUrl     String?
  
  // ×”×’×“×¨×•×ª
  isActive       Boolean  @default(true)
  cooldownMinutes Int     @default(5) // Prevent spam
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([organizationId, triggerActions])
}

enum AlertChannel {
  EMAIL
  WEBHOOK
  IN_APP
  SLACK
}
```

### 3. AuditRetentionConfig (×‘-Main DB)

```prisma
model AuditRetentionConfig {
  id             String   @id @default(uuid())
  organizationId String   @unique
  organization   Organization @relation(...)
  
  retentionDays  Int      @default(1095) // 3 years = 1095 days
  autoArchive    Boolean  @default(true)
  archiveAfterDays Int    @default(365)  // Archive after 1 year
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}
```

### 4. UserAlertPreferences (×‘-Main DB)

```prisma
model UserAlertPreferences {
  id             String   @id @default(uuid())
  userId         String
  user           User     @relation(...)
  organizationId String
  
  // ××” ×”××©×ª××© ×¨×•×¦×” ×œ×§×‘×œ
  enabledAlerts  AuditAction[]
  channels       AlertChannel[]
  
  // ×”×’×“×¨×•×ª ××™×©×™×•×ª
  emailDigest    DigestFrequency @default(REALTIME)
  quietHoursStart String?        // "22:00"
  quietHoursEnd   String?        // "08:00"
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId, organizationId])
}

enum DigestFrequency {
  REALTIME
  HOURLY
  DAILY
  WEEKLY
}
```

---

## ğŸ” ×”×¨×©××•×ª ×¦×¤×™×™×” ×‘×œ×•×’×™×

| ×ª×¤×§×™×“ | ×¦×¤×™×™×” | ×¡×™× ×•×Ÿ | ×™×™×¦×•× | ×”×’×“×¨×ª ×”×ª×¨××•×ª |
|-------|:-----:|:-----:|:-----:|:------------:|
| **Super Admin** | ×›×œ ×”××¨×’×•× ×™× | âœ… | âœ… | âœ… |
| **ADMIN** | ×›×œ ×”××¨×’×•×Ÿ | âœ… | âœ… | âœ… |
| **MANAGER** | ×¨×§ ×™×©×•×™×•×ª ×©×× ×”×œ | âœ… | âœ… | ×œ×¢×¦××• |
| **MEMBER** | ×¨×§ ×¤×¢×•×œ×•×ª ×©×œ×• | âŒ | âŒ | ×œ×¢×¦××• |
| **VIEWER** | âŒ | âŒ | âŒ | âŒ |

---

## ğŸ–¥ï¸ ×××©×§ ××©×ª××©

### ×“×£ ×™×•××Ÿ ×¤×¢×™×œ×•×ª (`/:slug/audit-log`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ“‹ ×™×•××Ÿ ×¤×¢×™×œ×•×ª                                    [×™×™×¦×•× CSV]  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ×¡×™× ×•×Ÿ:                                                         â”‚
â”‚  [××©×ª××© â–¼] [×¤×¢×•×œ×” â–¼] [×™×©×•×ª â–¼] [×: __/__/____] [×¢×“: __/__/____] â”‚
â”‚                                                                  â”‚
â”‚  ğŸ” ×—×™×¤×•×© ×—×•×¤×©×™: [________________________]                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸŸ¢ 14:32:15 | ×—×™×™× ××œ×¢×–×¨ | ×¢×“×›×Ÿ | ×¡×œ×¢                     â”‚  â”‚
â”‚  â”‚    "××¢×¨×›×ª ×“×©×‘×•×¨×“×™×"                                       â”‚  â”‚
â”‚  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                       â”‚  â”‚
â”‚  â”‚    ğŸ“ ×©×™× ×•×™×™×:                                            â”‚  â”‚
â”‚  â”‚    â€¢ progress: 50% â†’ 75%                                  â”‚  â”‚
â”‚  â”‚    â€¢ status: "×‘×ª×”×œ×™×š" â†’ "×”×•×©×œ×"                           â”‚  â”‚
â”‚  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                       â”‚  â”‚
â”‚  â”‚    ğŸ”— IP: 192.168.1.1 | Chrome | Session: abc123          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ğŸŸ¡ 14:28:03 | ×“× ×™ ×›×”×Ÿ | ×™×¦×¨ | ××‘×Ÿ ×“×¨×š                     â”‚  â”‚
â”‚  â”‚    "×¢×™×¦×•×‘ UI ×—×“×©"                                         â”‚  â”‚
â”‚  â”‚    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”                       â”‚  â”‚
â”‚  â”‚    ğŸ“ × ×ª×•× ×™× ×—×“×©×™×:                                       â”‚  â”‚
â”‚  â”‚    { title: "×¢×™×¦×•×‘ UI ×—×“×©", sprintId: "...", ... }       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                  â”‚
â”‚  [â—€ ×”×§×•×“×] ×¢××•×“ 1 ××ª×•×š 50 [×”×‘× â–¶]                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ×“×£ ×”×’×“×¨×•×ª ×”×ª×¨××•×ª (`/:slug/settings/alerts`)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ”” ×”×’×“×¨×•×ª ×”×ª×¨××•×ª                                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  ğŸ“§ ×”×¢×“×¤×•×ª ×©×œ×™×—×”:                                               â”‚
â”‚  â”œâ”€ [âœ“] ××™×™×œ                                                    â”‚
â”‚  â”œâ”€ [âœ“] ×”×ª×¨××” ×‘××¢×¨×›×ª                                           â”‚
â”‚  â””â”€ [ ] Webhook                                                 â”‚
â”‚                                                                  â”‚
â”‚  ğŸ“Š ×ª×“×™×¨×•×ª:                                                     â”‚
â”‚  [×‘×–××Ÿ ×××ª â–¼]                                                   â”‚
â”‚                                                                  â”‚
â”‚  ğŸ”• ×©×¢×•×ª ×©×§×˜×•×ª:                                                 â”‚
â”‚  ×: [22:00] ×¢×“: [08:00]                                         â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ××™×¨×•×¢×™× ×œ×”×ª×¨××”:                                                â”‚
â”‚                                                                  â”‚
â”‚  âœ… Authentication                                               â”‚
â”‚     [âœ“] ×›× ×™×¡×” ×›×•×©×œ×ª                                            â”‚
â”‚     [âœ“] ×©×™× ×•×™ ×¡×™×¡××”                                             â”‚
â”‚                                                                  â”‚
â”‚  âœ… Data Changes                                                 â”‚
â”‚     [ ] ×™×¦×™×¨×ª ×¨×©×•××”                                             â”‚
â”‚     [âœ“] ××—×™×§×ª ×¨×©×•××”                                             â”‚
â”‚     [ ] ×¢×“×›×•×Ÿ ×¨×©×•××”                                              â”‚
â”‚                                                                  â”‚
â”‚  âœ… Administration                                               â”‚
â”‚     [âœ“] ×©×™× ×•×™ ×”×¨×©××•×ª                                            â”‚
â”‚     [âœ“] ×”×•×¡×¤×ª/×”×¡×¨×ª ××©×ª××©                                       â”‚
â”‚                                                                  â”‚
â”‚                                         [×©××•×¨ ×”×’×“×¨×•×ª]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ Flow: ×›×ª×™×‘×ª ×œ×•×’

```
1. User performs action (e.g., updates Rock)
         â”‚
         â–¼
2. Route handler processes request
         â”‚
         â–¼
3. Audit middleware captures:
   - Before: snapshot of entity
   - After: snapshot after change
   - User info from session
   - Request metadata
         â”‚
         â–¼
4. Audit Service:
   a. Determines which org's audit DB to use
   b. Writes log entry
   c. Checks alert configs
   d. Triggers alerts if needed
         â”‚
         â–¼
5. Alert Engine (async):
   - Filters by user preferences
   - Respects quiet hours
   - Sends via configured channels
```

---

## ğŸ“ ××‘× ×” ×§×‘×¦×™×

```
server/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ modules/
â”‚   â”‚   â””â”€â”€ audit/
â”‚   â”‚       â”œâ”€â”€ audit.service.js      # Core logging logic
â”‚   â”‚       â”œâ”€â”€ audit.routes.js       # API endpoints
â”‚   â”‚       â”œâ”€â”€ audit.middleware.js   # Auto-capture middleware
â”‚   â”‚       â”œâ”€â”€ audit.schema.js       # Zod validation
â”‚   â”‚       â””â”€â”€ audit.types.js        # TypeScript types
â”‚   â”‚
â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”œâ”€â”€ audit-db.service.js       # Per-org DB connections
â”‚   â”‚   â”œâ”€â”€ alert.service.js          # Alert processing
â”‚   â”‚   â””â”€â”€ webhook.service.js        # Webhook dispatch
â”‚   â”‚
â”‚   â””â”€â”€ jobs/
â”‚       â”œâ”€â”€ audit-cleanup.job.js      # Retention enforcement
â”‚       â””â”€â”€ audit-archive.job.js      # Archiving old logs
â”‚
â”œâ”€â”€ prisma/
â”‚   â”œâ”€â”€ schema.prisma                 # Main DB schema
â”‚   â””â”€â”€ audit-schema.prisma           # Audit DB schema template
```

---

## ğŸš€ ×©×œ×‘×™ ×¤×™×ª×•×—

### Phase 1: Core Logging (MVP)
- [ ] ××‘× ×” DB ×‘×¡×™×¡×™
- [ ] Middleware ×œ×›×ª×™×‘×ª ×œ×•×’×™×
- [ ] API ×œ×§×¨×™××ª ×œ×•×’×™×
- [ ] UI ×‘×¡×™×¡×™ ×œ×¦×¤×™×™×”

### Phase 2: Alerts
- [ ] ×”×’×“×¨×ª ×”×ª×¨××•×ª
- [ ] ×©×œ×™×—×ª ××™×™×œ×™×
- [ ] ×”×ª×¨××•×ª In-App

### Phase 3: Advanced
- [ ] Webhook support
- [ ] ×™×™×¦×•× CSV
- [ ] Retention management
- [ ] Archive functionality

### Phase 4: Optimization
- [ ] DB per organization
- [ ] Search optimization
- [ ] Dashboard analytics

---

## âš ï¸ ×©××œ×” ×¤×ª×•×—×”: DB × ×¤×¨×“ ×œ×›×œ ××¨×’×•×Ÿ

**××¤×©×¨×•×™×•×ª:**

| ××¤×©×¨×•×ª | ×™×ª×¨×•× ×•×ª | ×—×¡×¨×•× ×•×ª |
|--------|---------|---------|
| **A: PostgreSQL Schema per org** | ×”×¤×¨×“×” ×˜×•×‘×”, DB ××—×“ | ××•×¨×›×‘×•×ª ×‘× ×™×”×•×œ |
| **B: Separate PostgreSQL per org** | ×”×¤×¨×“×” ××œ××” | ×™×§×¨, ××•×¨×›×‘ ×××•×“ |
| **C: Same table + RLS** | ×¤×©×•×˜, ×–×•×œ | ×¤×—×•×ª ×”×¤×¨×“×” |
| **D: External Service (e.g., Elasticsearch)** | ×‘×™×¦×•×¢×™×, ×—×™×¤×•×© | ×¢×œ×•×ª × ×•×¡×¤×ª |

**×”××œ×¦×”:** ×œ×”×ª×—×™×œ ×¢× **C** (RLS), ×•×‘×©×œ×‘ ×××•×—×¨ ×™×•×ª×¨ ×œ×¢×‘×•×¨ ×œ-**A** ××• **D** ×œ×¤×™ ×¦×•×¨×š.

---

## âœ… ××•×›×Ÿ ×œ×¤×™×ª×•×—?

×œ××—×¨ ××™×©×•×¨ ××¡××š ×–×”, × ×ª×—×™×œ ×‘×¤×™×ª×•×— Phase 1.

