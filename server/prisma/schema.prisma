// Prisma Schema for Sprint Management System
// Multi-tenant with Organization support and Audit fields

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN      // Full access - manage users, all CRUD
  MANAGER    // Create, edit, delete rocks/sprints/stories
  MEMBER     // View all, edit own stories
  VIEWER     // View only
}

enum TaskStatus {
  TODO        // לעשות
  IN_PROGRESS // בתהליך
  DONE        // הושלם
  CANCELLED   // בוטל
}

// ==================== ORGANIZATION (Multi-tenant) ====================

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique  // "company-abc" - for URLs
  logo        String?
  isActive    Boolean  @default(true)
  settings    Json?    // { theme, language, etc }
  
  // Relations
  members       OrganizationMember[]
  teamMembers   TeamMember[]
  objectives    Objective[]
  rocks         Rock[]
  sprints       Sprint[]
  stories       Story[]
  tasks         Task[]
  allowedEmails AllowedEmail[]
  featureFlags  FeatureFlag[]
  
  // Audit System
  auditLogs           AuditLog[]
  auditAlertConfigs   AuditAlertConfig[]
  auditRetentionConfig AuditRetentionConfig?
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
}

// קשר בין User לארגונים (M:N)
model OrganizationMember {
  id             String   @id @default(uuid())
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role           UserRole @default(VIEWER)  // תפקיד בארגון הספציפי
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ==================== USER ====================

model User {
  id            String   @id @default(uuid())
  googleId      String   @unique
  email         String   @unique
  name          String
  picture       String?
  isActive      Boolean  @default(true)
  
  // Super Admin - מנהל פלטפורמה שרואה את כל הארגונים
  isSuperAdmin  Boolean  @default(false)
  
  // Legacy role - for backwards compatibility during migration
  role          UserRole @default(VIEWER)
  
  // Relations
  organizations OrganizationMember[]
  teamMember    TeamMember?
  alertPreferences UserAlertPreferences[]
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([email])
  @@index([isSuperAdmin])
}

// ==================== TEAM MEMBER ====================

model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String   // Job title
  capacity  Int?     // points per sprint
  isActive  Boolean  @default(true)
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Link to User (optional)
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id])
  
  // Relations
  ownedRocks      Rock[]
  ownedStories    Story[]
  ownedObjectives Objective[]
  ownedTasks      Task[]       @relation("TaskOwner")
  createdTasks    Task[]       @relation("TaskCreator")
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  
  @@index([organizationId])
  @@index([isActive])
  @@index([name])
}

// ==================== OBJECTIVE ====================
// פרויקט - ללא תאריך, רק מאגד סלעים

model Objective {
  id          String   @id @default(uuid())
  code        String   // "OBJ-01" - unique per organization
  name        String
  description String?
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Owner
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id])
  
  // Relations
  rocks       Rock[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([ownerId])
}

// ==================== ROCK ====================
// סלע - יעד רבעוני

model Rock {
  id              String   @id @default(uuid())
  code            String   // "2025-Q4-01" - unique per organization
  name            String
  description     String?
  
  // רבעון ושנה
  year            Int      @default(2025)
  quarter         Int      @default(4)  // 1-4
  
  // התקדמות
  progress        Int      @default(0)      // 0-100, manual override
  // calculatedProgress is computed dynamically, not stored
  
  // גלישה מרבעון קודם
  isCarriedOver   Boolean  @default(false)
  carriedFromQuarter Int?  // מאיזה רבעון גלש
  
  // Organization
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  
  // Owner
  ownerId         String?
  owner           TeamMember? @relation(fields: [ownerId], references: [id])
  
  // Objective
  objectiveId     String?
  objective       Objective?  @relation(fields: [objectiveId], references: [id], onDelete: SetNull)
  
  // Relations
  stories         Story[]
  sprintRocks     SprintRock[]
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, year, quarter])
  @@index([objectiveId])
  @@index([ownerId])
}

// ==================== SPRINT ====================
// ספרינט - תקופת עבודה קצובה (בדרך כלל שבועיים)

model Sprint {
  id             String   @id @default(uuid())
  name           String   // Auto: "2026-Q2-S5" - unique per organization
  goal           String?
  
  // מזהי ספרינט
  year           Int      @default(2025)
  quarter        Int      @default(4)  // 1-4
  sprintNumber   Int      @default(1)  // 1-6
  
  // תאריכים
  startDate      DateTime
  endDate        DateTime
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Relations
  sprintRocks    SprintRock[]
  stories        Story[]
  
  // Audit
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?
  
  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, year, quarter])
  @@index([startDate, endDate])
}

// ==================== SPRINT-ROCK (M:N) ====================

model SprintRock {
  id        String  @id @default(uuid())
  
  sprintId  String
  sprint    Sprint  @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  
  rockId    String
  rock      Rock    @relation(fields: [rockId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([sprintId, rockId])
  @@index([sprintId])
  @@index([rockId])
}

// ==================== STORY (אבן דרך) ====================

model Story {
  id          String   @id @default(uuid())
  code        String?  // "ed-01" - קוד אבן דרך
  title       String
  description String?
  
  // התקדמות (0-100) - ניתן לעדכון ידני
  progress    Int      @default(0)
  
  // חסום - כאשר true, ההתקדמות תקועה
  isBlocked   Boolean  @default(false)
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // ספרינט - אופציונלי (אם אין = "אבני דרך בהמתנה")
  sprintId    String?
  sprint      Sprint?  @relation(fields: [sprintId], references: [id], onDelete: SetNull)
  
  // סלע - אופציונלי
  rockId      String?
  rock        Rock?    @relation(fields: [rockId], references: [id], onDelete: SetNull)
  
  // אחראי - אופציונלי
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  
  @@index([organizationId])
  @@index([sprintId])
  @@index([rockId])
  @@index([ownerId])
  @@index([isBlocked])
  @@index([organizationId, sprintId])
  
  // Relations
  tasks       Task[]
}

// ==================== TASK (משימה) ====================
// משימות קשורות לאבני דרך או עצמאיות

model Task {
  id              String       @id @default(cuid())
  code            String?      // "m-01" - קוד משימה
  title           String       // כותרת המשימה
  description     String?      // תיאור (אופציונלי)
  status          TaskStatus   @default(TODO)
  priority        Int          @default(0)  // 0=רגיל, 1=גבוה, 2=דחוף
  dueDate         DateTime?    // תאריך יעד (אופציונלי)
  completedAt     DateTime?    // מתי הושלמה
  sortOrder       Int          @default(0)  // סדר בתוך אבן דרך
  
  // קשר לאבן דרך - אופציונלי (null = משימה עצמאית)
  storyId         String?
  story           Story?       @relation(fields: [storyId], references: [id], onDelete: SetNull)
  
  // אחראי על המשימה
  ownerId         String
  owner           TeamMember   @relation("TaskOwner", fields: [ownerId], references: [id])
  
  // מי יצר את המשימה
  createdById     String?
  createdBy       TeamMember?  @relation("TaskCreator", fields: [createdById], references: [id])
  
  // Organization (multi-tenant)
  organizationId  String
  organization    Organization @relation(fields: [organizationId], references: [id])
  
  // Audit
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt

  // אינדקסים לביצועים
  @@index([organizationId])
  @@index([ownerId])
  @@index([storyId])
  @@index([status])
  @@index([dueDate])
  @@index([organizationId, ownerId, status])  // שאילתה נפוצה: "המשימות שלי"
}

// ==================== ACCESS CONTROL ====================

model AllowedEmail {
  id          String   @id @default(uuid())
  email       String   // unique per organization
  name        String?
  role        UserRole @default(VIEWER)
  note        String?
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Audit
  addedBy     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}

// ==================== AUDIT LOG SYSTEM ====================
// Designed with abstraction layer for future migration to separate DB per org

model AuditLog {
  id             String   @id @default(uuid())
  
  // ===== Organization (for RLS) =====
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  // ===== Who =====
  userId         String?
  userEmail      String?
  userName       String?
  userRole       String?      // Role at time of action
  
  // ===== What =====
  action         String       // CREATE, UPDATE, DELETE, LOGIN, etc.
  category       String       // AUTHENTICATION, DATA_CRUD, ADMINISTRATION, etc.
  entityType     String       // Rock, Sprint, Story, User, etc.
  entityId       String?
  entityName     String?      // Human-readable name for quick reference
  
  // ===== Changes (Full Detail) =====
  oldValues      Json?        // Full snapshot before change
  newValues      Json?        // Full snapshot after change
  changedFields  String[]     // ['name', 'progress', 'status']
  changesSummary String?      // Human-readable: "progress: 50% → 75%"
  
  // ===== Context =====
  ipAddress      String?
  userAgent      String?
  sessionId      String?
  requestId      String?      // For distributed tracing
  requestPath    String?      // /api/rocks/123
  requestMethod  String?      // GET, POST, PUT, DELETE
  duration       Int?         // Action duration in ms
  
  // ===== Metadata =====
  metadata       Json?        // Additional context
  
  // ===== Time =====
  createdAt      DateTime @default(now())
  
  // ===== Indexes for performance =====
  @@index([organizationId, createdAt])
  @@index([organizationId, userId])
  @@index([organizationId, action])
  @@index([organizationId, category])
  @@index([organizationId, entityType])
  @@index([entityType, entityId])
}

// Alert Configuration per Organization
model AuditAlertConfig {
  id             String   @id @default(uuid())
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  name           String       // "מחיקת רשומות", "כניסות כושלות"
  description    String?
  
  // What triggers the alert
  triggerActions String[]     // ['DELETE', 'LOGIN_FAILED']
  triggerEntities String[]    // ['Rock', 'Story'] or ['*'] for all
  
  // Who receives the alert
  notifyRoles    String[]     // ['ADMIN', 'MANAGER']
  notifyUserIds  String[]     // Specific user IDs
  
  // How to send
  channelEmail   Boolean      @default(true)
  channelInApp   Boolean      @default(true)
  channelWebhook Boolean      @default(false)
  webhookUrl     String?
  webhookSecret  String?      // For signing webhook payloads
  
  // Settings
  isActive       Boolean      @default(true)
  cooldownMinutes Int         @default(5)  // Prevent alert spam
  
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  createdBy      String?
  
  @@index([organizationId, isActive])
}

// Retention settings per Organization
model AuditRetentionConfig {
  id             String   @id @default(uuid())
  
  organizationId String   @unique
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  retentionDays  Int      @default(1095) // 3 years = 1095 days
  autoArchive    Boolean  @default(true)
  archiveAfterDays Int    @default(365)  // Move to archive after 1 year
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  updatedBy      String?
}

// User's personal alert preferences
model UserAlertPreferences {
  id             String   @id @default(uuid())
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  
  // Which alerts to receive
  enabledActions String[]     // ['DELETE', 'ROLE_CHANGED']
  disabledActions String[]    // Explicitly disabled
  
  // Delivery preferences
  channelEmail   Boolean      @default(true)
  channelInApp   Boolean      @default(true)
  
  // Timing
  digestFrequency String      @default("REALTIME") // REALTIME, HOURLY, DAILY
  quietHoursStart String?     // "22:00"
  quietHoursEnd   String?     // "08:00"
  timezone       String       @default("Asia/Jerusalem")
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId, organizationId])
}

// In-app notifications queue
model AuditNotification {
  id             String   @id @default(uuid())
  
  organizationId String
  userId         String       // Recipient
  
  alertConfigId  String?      // Which alert config triggered this
  auditLogId     String?      // Reference to the audit log entry
  
  title          String
  message        String
  severity       String       @default("info") // low, medium, high, info
  
  isRead         Boolean      @default(false)
  readAt         DateTime?
  
  createdAt      DateTime     @default(now())
  
  @@index([organizationId, userId, isRead])
  @@index([createdAt])
}

// ==================== CONFIGURATION TABLES ====================
// הגדרות מאוחסנות ב-DB במקום בקוד

// הגדרות מערכת גלובליות
model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  
  updatedAt   DateTime @updatedAt
  updatedBy   String?
}

// הרשאות - הגדרת כל ההרשאות האפשריות במערכת
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique   // 'rocks:create', 'sprints:delete'
  name        String             // 'יצירת סלעים'
  category    String?            // 'rocks', 'sprints', 'admin'
  description String?
  
  roles       RolePermission[]
}

// תפקידים דינמיים - החלפת ה-enum הקשיח
model Role {
  id          String   @id @default(uuid())
  code        String   @unique   // 'ADMIN', 'MANAGER', 'CUSTOM_ROLE'
  name        String             // 'מנהל', 'מנהל פרויקט'
  description String?
  color       String?            // '#FF5733' for UI
  hierarchy   Int      @default(100) // Lower = more powerful
  isSystem    Boolean  @default(false) // System roles can't be deleted
  
  permissions RolePermission[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// קשר בין תפקידים להרשאות (M:N)
model RolePermission {
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@id([roleId, permissionId])
}

// דגלי פיצ'רים - הפעלה/כיבוי של תכונות
model FeatureFlag {
  id             String   @id @default(uuid())
  key            String   // 'dark_mode', 'ai_assistant'
  isEnabled      Boolean  @default(false)
  
  // אם null = גלובלי, אחרת ספציפי לארגון
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  description    String?
  
  updatedAt      DateTime @updatedAt
  
  @@unique([key, organizationId])
}

// מיילים של Super Admins - במקום hardcoded בקוד
model SuperAdminEmail {
  id        String   @id @default(uuid())
  email     String   @unique
  note      String?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  createdBy String?
}
