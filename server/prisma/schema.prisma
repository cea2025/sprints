// Prisma Schema for Sprint Management System
// Simplified with progress tracking

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN      // Full access - manage users, all CRUD
  MANAGER    // Create, edit, delete rocks/sprints/stories
  MEMBER     // View all, edit own stories
  VIEWER     // View only
}

// ==================== MODELS ====================

model User {
  id            String   @id @default(uuid())
  googleId      String   @unique
  email         String   @unique
  name          String
  picture       String?
  role          UserRole @default(VIEWER)
  isActive      Boolean  @default(true)
  
  teamMember    TeamMember?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String
  capacity  Int?     // points per sprint
  isActive  Boolean  @default(true)
  
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id])
  
  ownedRocks      Rock[]
  ownedStories    Story[]
  ownedObjectives Objective[]
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ==================== OBJECTIVE ====================
// מטרת-על - ללא תאריך, רק מאגדת סלעים

model Objective {
  id          String   @id @default(uuid())
  code        String   @unique  // "OBJ-01"
  name        String
  description String?
  
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id])
  
  rocks       Rock[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== ROCK ====================
// סלע - יעד רבעוני

model Rock {
  id              String   @id @default(uuid())
  code            String   @unique  // "2025-Q4-01"
  name            String
  description     String?
  
  // רבעון ושנה
  year            Int      @default(2025)
  quarter         Int      @default(4)  // 1-4
  
  // התקדמות (0-100)
  progress        Int      @default(0)
  
  // גלישה מרבעון קודם
  isCarriedOver   Boolean  @default(false)
  carriedFromQuarter Int?  // מאיזה רבעון גלש
  
  // קשרים
  ownerId         String?
  owner           TeamMember? @relation(fields: [ownerId], references: [id])
  
  objectiveId     String?
  objective       Objective?  @relation(fields: [objectiveId], references: [id])
  
  stories         Story[]
  sprintRocks     SprintRock[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ==================== SPRINT ====================
// ספרינט - תקופת עבודה קצובה (בדרך כלל שבועיים)

model Sprint {
  id             String   @id @default(uuid())
  name           String   @unique  // Auto: "2026-Q2-S5"
  goal           String?
  
  // מזהי ספרינט
  year           Int      @default(2025)
  quarter        Int      @default(4)  // 1-4
  sprintNumber   Int      @default(1)  // 1-6
  
  // תאריכים
  startDate      DateTime
  endDate        DateTime
  
  // קשרים M:N עם סלעים
  sprintRocks    SprintRock[]
  stories        Story[]
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
}

// ==================== SPRINT-ROCK (M:N) ====================

model SprintRock {
  id        String  @id @default(uuid())
  
  sprintId  String
  sprint    Sprint  @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  
  rockId    String
  rock      Rock    @relation(fields: [rockId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([sprintId, rockId])
}

// ==================== STORY (אבן דרך) ====================

model Story {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  // התקדמות (0-100) - ניתן לעדכון ידני
  progress    Int      @default(0)
  
  // חסום - כאשר true, ההתקדמות תקועה
  isBlocked   Boolean  @default(false)
  
  // ספרינט - חובה
  sprintId    String
  sprint      Sprint   @relation(fields: [sprintId], references: [id])
  
  // סלע - אופציונלי
  rockId      String?
  rock        Rock?    @relation(fields: [rockId], references: [id])
  
  // אחראי - אופציונלי (כדי לאפשר מחיקת חברי צוות)
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ==================== ACCESS CONTROL ====================

model AllowedEmail {
  id          String   @id @default(uuid())
  email       String   @unique
  name        String?
  role        UserRole @default(VIEWER)
  addedBy     String?
  note        String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
