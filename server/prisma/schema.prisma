// Prisma Schema for Sprint Management System
// Multi-tenant with Organization support and Audit fields

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ==================== ENUMS ====================

enum UserRole {
  ADMIN      // Full access - manage users, all CRUD
  MANAGER    // Create, edit, delete rocks/sprints/stories
  MEMBER     // View all, edit own stories
  VIEWER     // View only
}

// ==================== ORGANIZATION (Multi-tenant) ====================

model Organization {
  id          String   @id @default(uuid())
  name        String
  slug        String   @unique  // "company-abc" - for URLs
  logo        String?
  isActive    Boolean  @default(true)
  settings    Json?    // { theme, language, etc }
  
  // Relations
  members       OrganizationMember[]
  teamMembers   TeamMember[]
  objectives    Objective[]
  rocks         Rock[]
  sprints       Sprint[]
  stories       Story[]
  allowedEmails AllowedEmail[]
  featureFlags  FeatureFlag[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
}

// קשר בין User לארגונים (M:N)
model OrganizationMember {
  id             String   @id @default(uuid())
  
  userId         String
  user           User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  organizationId String
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  role           UserRole @default(VIEWER)  // תפקיד בארגון הספציפי
  isActive       Boolean  @default(true)
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  @@unique([userId, organizationId])
  @@index([userId])
  @@index([organizationId])
}

// ==================== USER ====================

model User {
  id            String   @id @default(uuid())
  googleId      String   @unique
  email         String   @unique
  name          String
  picture       String?
  isActive      Boolean  @default(true)
  
  // Super Admin - מנהל פלטפורמה שרואה את כל הארגונים
  isSuperAdmin  Boolean  @default(false)
  
  // Legacy role - for backwards compatibility during migration
  role          UserRole @default(VIEWER)
  
  // Relations
  organizations OrganizationMember[]
  teamMember    TeamMember?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([email])
  @@index([isSuperAdmin])
}

// ==================== TEAM MEMBER ====================

model TeamMember {
  id        String   @id @default(uuid())
  name      String
  role      String   // Job title
  capacity  Int?     // points per sprint
  isActive  Boolean  @default(true)
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Link to User (optional)
  userId    String?  @unique
  user      User?    @relation(fields: [userId], references: [id])
  
  // Relations
  ownedRocks      Rock[]
  ownedStories    Story[]
  ownedObjectives Objective[]
  
  // Audit
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
  deletedAt DateTime?
  deletedBy String?
  
  @@index([organizationId])
  @@index([isActive])
  @@index([name])
}

// ==================== OBJECTIVE ====================
// מטרת-על - ללא תאריך, רק מאגדת סלעים

model Objective {
  id          String   @id @default(uuid())
  code        String   // "OBJ-01" - unique per organization
  name        String
  description String?
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Owner
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id])
  
  // Relations
  rocks       Rock[]
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([ownerId])
}

// ==================== ROCK ====================
// סלע - יעד רבעוני

model Rock {
  id              String   @id @default(uuid())
  code            String   // "2025-Q4-01" - unique per organization
  name            String
  description     String?
  
  // רבעון ושנה
  year            Int      @default(2025)
  quarter         Int      @default(4)  // 1-4
  
  // התקדמות
  progress        Int      @default(0)      // 0-100, manual override
  // calculatedProgress is computed dynamically, not stored
  
  // גלישה מרבעון קודם
  isCarriedOver   Boolean  @default(false)
  carriedFromQuarter Int?  // מאיזה רבעון גלש
  
  // Organization
  organizationId  String?
  organization    Organization? @relation(fields: [organizationId], references: [id])
  
  // Owner
  ownerId         String?
  owner           TeamMember? @relation(fields: [ownerId], references: [id])
  
  // Objective
  objectiveId     String?
  objective       Objective?  @relation(fields: [objectiveId], references: [id])
  
  // Relations
  stories         Story[]
  sprintRocks     SprintRock[]
  
  // Audit
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  createdBy       String?
  updatedBy       String?
  deletedAt       DateTime?
  deletedBy       String?
  
  @@unique([organizationId, code])
  @@index([organizationId])
  @@index([organizationId, year, quarter])
  @@index([objectiveId])
  @@index([ownerId])
}

// ==================== SPRINT ====================
// ספרינט - תקופת עבודה קצובה (בדרך כלל שבועיים)

model Sprint {
  id             String   @id @default(uuid())
  name           String   // Auto: "2026-Q2-S5" - unique per organization
  goal           String?
  
  // מזהי ספרינט
  year           Int      @default(2025)
  quarter        Int      @default(4)  // 1-4
  sprintNumber   Int      @default(1)  // 1-6
  
  // תאריכים
  startDate      DateTime
  endDate        DateTime
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Relations
  sprintRocks    SprintRock[]
  stories        Story[]
  
  // Audit
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  createdBy      String?
  updatedBy      String?
  deletedAt      DateTime?
  deletedBy      String?
  
  @@unique([organizationId, name])
  @@index([organizationId])
  @@index([organizationId, year, quarter])
  @@index([startDate, endDate])
}

// ==================== SPRINT-ROCK (M:N) ====================

model SprintRock {
  id        String  @id @default(uuid())
  
  sprintId  String
  sprint    Sprint  @relation(fields: [sprintId], references: [id], onDelete: Cascade)
  
  rockId    String
  rock      Rock    @relation(fields: [rockId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@unique([sprintId, rockId])
  @@index([sprintId])
  @@index([rockId])
}

// ==================== STORY (אבן דרך) ====================

model Story {
  id          String   @id @default(uuid())
  title       String
  description String?
  
  // התקדמות (0-100) - ניתן לעדכון ידני
  progress    Int      @default(0)
  
  // חסום - כאשר true, ההתקדמות תקועה
  isBlocked   Boolean  @default(false)
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // ספרינט - חובה
  sprintId    String
  sprint      Sprint   @relation(fields: [sprintId], references: [id], onDelete: Restrict)
  
  // סלע - אופציונלי
  rockId      String?
  rock        Rock?    @relation(fields: [rockId], references: [id], onDelete: SetNull)
  
  // אחראי - אופציונלי
  ownerId     String?
  owner       TeamMember? @relation(fields: [ownerId], references: [id], onDelete: SetNull)
  
  // Audit
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  deletedAt   DateTime?
  deletedBy   String?
  
  @@index([organizationId])
  @@index([sprintId])
  @@index([rockId])
  @@index([ownerId])
  @@index([isBlocked])
  @@index([organizationId, sprintId])
}

// ==================== ACCESS CONTROL ====================

model AllowedEmail {
  id          String   @id @default(uuid())
  email       String   // unique per organization
  name        String?
  role        UserRole @default(VIEWER)
  note        String?
  
  // Organization
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])
  
  // Audit
  addedBy     String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([organizationId, email])
  @@index([organizationId])
  @@index([email])
}

// ==================== AUDIT LOG ====================

model AuditLog {
  id             String   @id @default(uuid())
  
  organizationId String?
  userId         String?
  userEmail      String?
  
  action         String   // CREATE, UPDATE, DELETE, LOGIN, etc.
  entityType     String   // Rock, Sprint, Story, etc.
  entityId       String?
  
  oldValues      Json?
  newValues      Json?
  
  ipAddress      String?
  userAgent      String?
  
  createdAt      DateTime @default(now())
  
  @@index([organizationId, createdAt])
  @@index([entityType, entityId])
}

// ==================== CONFIGURATION TABLES ====================
// הגדרות מאוחסנות ב-DB במקום בקוד

// הגדרות מערכת גלובליות
model SystemSetting {
  id          String   @id @default(uuid())
  key         String   @unique
  value       Json
  description String?
  
  updatedAt   DateTime @updatedAt
  updatedBy   String?
}

// הרשאות - הגדרת כל ההרשאות האפשריות במערכת
model Permission {
  id          String   @id @default(uuid())
  code        String   @unique   // 'rocks:create', 'sprints:delete'
  name        String             // 'יצירת סלעים'
  category    String?            // 'rocks', 'sprints', 'admin'
  description String?
  
  roles       RolePermission[]
}

// תפקידים דינמיים - החלפת ה-enum הקשיח
model Role {
  id          String   @id @default(uuid())
  code        String   @unique   // 'ADMIN', 'MANAGER', 'CUSTOM_ROLE'
  name        String             // 'מנהל', 'מנהל פרויקט'
  description String?
  color       String?            // '#FF5733' for UI
  hierarchy   Int      @default(100) // Lower = more powerful
  isSystem    Boolean  @default(false) // System roles can't be deleted
  
  permissions RolePermission[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// קשר בין תפקידים להרשאות (M:N)
model RolePermission {
  roleId       String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  
  permissionId String
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  
  @@id([roleId, permissionId])
}

// דגלי פיצ'רים - הפעלה/כיבוי של תכונות
model FeatureFlag {
  id             String   @id @default(uuid())
  key            String   // 'dark_mode', 'ai_assistant'
  isEnabled      Boolean  @default(false)
  
  // אם null = גלובלי, אחרת ספציפי לארגון
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  
  description    String?
  
  updatedAt      DateTime @updatedAt
  
  @@unique([key, organizationId])
}

// מיילים של Super Admins - במקום hardcoded בקוד
model SuperAdminEmail {
  id        String   @id @default(uuid())
  email     String   @unique
  note      String?
  isActive  Boolean  @default(true)
  
  createdAt DateTime @default(now())
  createdBy String?
}
